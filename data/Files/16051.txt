Title: XML external entity attack
Aspects: {'XEE'}

An XML External Entity attack is a type of attack against an application that parses XML input. This attack occurs when XML input containing a reference to an external entity is processed by a weakly configured XML parser. This attack may lead to the disclosure of confidential data, denial of service, server side request forgery, port scanning from the perspective of the machine where the parser is located, and other system impacts.


== Description ==
The XML 1.0 standard defines the structure of an XML document. The standard defines a concept called an entity, which is a storage unit of some type. There are a few different types of entities, external general/parameter parsed entity often shortened to external entity, that can access local or remote content via a declared system identifier. The system identifier is assumed to be a URI that can be dereferenced (accessed) by the XML processor when processing the entity. The XML processor then replaces occurrences of the named external entity with the contents dereferenced by the system identifier. If the system identifier contains tainted data and the XML processor dereferences this tainted data, the XML processor may disclose confidential information normally not accessible by the application. Similar attack vectors apply the usage of external DTDs, external style sheets, external schemas, etc. which, when included, allow similar external resource inclusion style attacks.
Attacks can include disclosing local files, which may contain sensitive data such as passwords or private user data, using file: schemes or relative paths in the system identifier. Since the attack occurs relative to the application processing the XML document, an attacker may use this trusted application to pivot to other internal systems, possibly disclosing other internal content via http(s) requests or launching a CSRF attack to any unprotected internal services. In some situations, an XML processor library that is vulnerable to client-side memory corruption issues may be exploited by dereferencing a malicious URI, possibly allowing arbitrary code execution under the application account. Other attacks can access local resources that may not stop returning data, possibly impacting application availability if too many threads or processes are not released.
Note that the application does not need to explicitly return the response to the attacker for it to be vulnerable to information disclosures. An attacker can leverage DNS information to exfiltrate data through subdomain names to a DNS server under their control.


== Risk factors ==
The application parses XML documents.
Tainted data is allowed within the system identifier portion of the entity, within the document type definition (DTD).
The XML processor is configured to validate and process the DTD.
The XML processor is configured to resolve external entities within the DTD.


== Examples ==
The examples below are from Testing for XML Injection (OWASP-DV-008).


=== Accessing a local resource that may not return ===


=== Remote code execution ===
When the PHP "expect" module is loaded, remote code execution may be possible with a modified payload.


=== Disclosing /etc/passwd or other targeted files ===


== Mitigation ==
Since the entire XML document is communicated from an untrusted client, it is not usually possible to selectively validate or escape tainted data within the system identifier in the DTD. Therefore, the XML processor should be configured to use a local static DTD and disallow any declared DTD included in the XML document.


== See also ==
SQL injection
Blind SQL injection


== References ==


== External links ==
OWASP XML External Entity (XXE) Prevention Cheat Sheet
Timothy Morgan's 2014 Paper: XML Schema, DTD, and Entity Attacks - A Compendium of Known Techniques
Precursor presentation of above paper - at OWASP AppSec USA 2013
CWE-611: Information Exposure Through XML External Entity Reference
CWE-827: Improper Control of Document Type Definition
Sascha Herzog's Presentation on XML External Entity Attacks - at OWASP AppSec Germany 2010
PostgreSQL XXE vulnerability
SharePoint and DotNetNuke XXE Vulnerabilities, in French
XML Denial of Service Attacks and Defenses (in .NET)
Early (2002) BugTraq Article on XXE
XML 1.0 Extensible Markup Language (XML) 1.0 (Fifth Edition)